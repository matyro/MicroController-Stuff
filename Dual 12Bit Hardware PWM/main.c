// Software from Dominik B. 
// https://github.com/matyro/MicroController-Stuff
// MIT License



#define F_CPU 8000000UL// 8MHz

#include <avr/io.h>
#include <avr/interrupt.h>
#include <util/delay.h>

#include <avr/cpufunc.h>
#include <avr/pgmspace.h>


/*
		VCC						|	GND					
		PB0						|	PA0		-	AREF
		PB1						|	PA1		-	AD1 Output
		PB3	-	Reset In		|	PA2		-	AD2 Output
		PB2						|	PA3
		PA7						|	PA4
		PA6	-	PWM Output 1	|	PA5		-	PWM Output 2

*/


// Log table in EPROM
const uint16_t pwmtable_16[1024] PROGMEM= {
	20,20,20,20,20,21,21,21,21,21,21,21,21,21,22,22,22,22,22,22,22,22,22,23,23,
	23,23,23,23,23,23,24,	24,24,24,24,24,24,24,24,25,25,25,25,25,25,25,26,26,
	26,26,26,26,26,26,27,27,27,27,27,27,27,28,28,28,28,28,28,28,29,29,29,29,29,
	29,30,30,30,30,30,30,30,31,31,31,31,31,31,32,32,32,32,32,32,33,33,33,33,33,
	33,34,34,34,34,34,35,35,35,35,35,35,36,36,36,36,36,37,37,37,37,37,38,38,38,
	38,38,39,39,39,39,39,40,40,40,40,40,41,41,41,41,41,42,42,42,42,43,43,43,43,
	43,44,44,44,44,45,45,45,45,45,46,46,46,46,47,47,47,47,48,48,48,48,49,49,49,
	49,50,50,50,50,51,51,51,52,52,52,52,53,53,53,53,54,54,54,55,55,55,55,56,56,
	56,57,57,57,58,58,58,58,59,59,59,60,60,60,61,61,61,62,62,62,62,63,63,63,64,
	64,64,65,65,65,66,66,67,67,67,68,68,68,69,69,69,70,70,70,71,71,72,72,72,73,
	73,73,74,74,75,75,75,76,76,77,77,77,78,78,79,79,79,80,80,81,81,81,82,82,83,
	83,84,84,85,85,85,86,86,87,87,88,88,89,89,89,90,90,91,91,92,92,93,93,94,94,
	95,95,96,96,97,97,98,98,99,99,100,100,101,101,102,102,103,104,104,105,105,106,106,107,107,
	108,108,109,110,110,111,111,112,112,113,114,114,115,115,116,117,117,118,119,119,120,120,121,122,122,
	123,124,124,125,125,126,127,127,128,129,129,130,131,131,132,133,134,134,135,136,136,137,138,139,139,
	140,141,141,142,143,144,144,145,146,147,147,148,149,150,151,151,152,153,154,155,155,156,157,158,159,
	159,160,161,162,163,164,164,165,166,167,168,169,170,171,171,172,173,174,175,176,177,178,179,180,181,
	182,182,183,184,185,186,187,188,189,190,191,192,193,194,195,196,197,198,199,200,201,203,204,205,206,
	207,208,209,210,211,212,213,214,216,217,218,219,220,221,222,224,225,226,227,228,229,231,232,233,234,
	235,237,238,239,240,242,243,244,245,247,248,249,251,252,253,255,256,257,259,260,261,263,264,265,267,
	268,270,271,272,274,275,277,278,280,281,283,284,285,287,288,290,291,293,295,296,298,299,301,302,304,
	305,307,309,310,312,313,315,317,318,320,322,323,325,327,329,330,332,334,335,337,339,341,342,344,346,
	348,350,352,353,355,357,359,361,363,365,366,368,370,372,374,376,378,380,382,384,386,388,390,392,394,
	396,398,400,402,405,407,409,411,413,415,417,420,422,424,426,428,431,433,435,437,440,442,444,447,449,
	451,454,456,458,461,463,466,468,470,473,475,478,480,483,485,488,490,493,496,498,501,503,506,509,511,
	514,517,519,522,525,527,530,533,536,539,541,544,547,550,553,556,559,561,564,567,570,573,576,579,582,
	585,588,591,594,598,601,604,607,610,613,617,620,623,626,629,633,636,639,643,646,649,653,656,660,663,
	667,670,674,677,681,684,688,691,695,699,702,706,710,713,717,721,724,728,732,736,740,744,747,751,755,
	759,763,767,771,775,779,783,787,791,796,800,804,808,812,817,821,825,829,834,838,842,847,851,856,860,
	865,869,874,878,883,887,892,897,901,906,911,916,920,925,930,935,940,945,949,954,959,964,969,974,980,
	985,990,995,1000,1005,1011,1016,1021,1027,1032,1037,1043,1048,1054,1059,1065,1070,1076,1081,1087,1093,1098,1104,1110,1116,
	1121,1127,1133,1139,1145,1151,1157,1163,1169,1175,1181,1187,1194,1200,1206,1212,1219,1225,1232,1238,1244,1251,1257,1264,1271,
	1277,1284,1291,1297,1304,1311,1318,1325,1331,1338,1345,1352,1359,1367,1374,1381,1388,1395,1403,1410,1417,1425,1432,1440,1447,
	1455,1462,1470,1477,1485,1493,1501,1509,1516,1524,1532,1540,1548,1556,1565,1573,1581,1589,1597,1606,1614,1623,1631,1640,1648,
	1657,1665,1674,1683,1691,1700,1709,1718,1727,1736,1745,1754,1763,1773,1782,1791,1800,1810,1819,1829,1838,1848,1858,1867,1877,
	1887,1897,1906,1916,1926,1936,1947,1957,1967,1977,1988,1998,2008,2019,2029,2040,2051,2061,2072,2083,2094,2105,2116,2127,2138,
	2149,2160,2171,2183,2194,2205,2217,2229,2240,2252,2264,2275,2287,2299,2311,2323,2335,2348,2360,2372,2384,2397,2409,2422,2435,
	2447,2460,2473,2486,2499,2512,2525,2538,2551,2565,2578,2591,2605,2619,2632,2646,2660,2674,2688,2702,2716,2730,2744,2758,2773,
	2787,2802,2816,2831,2846,2861,2876,2891,2906,2921,2936,2951,2967,2982,2998,3013,3029,3045,3061,3077,3093,3109,3125,3141,3158,
	3174,3191,3208,3224,3241,3258,3275,3292,3309,3326,3344,3361,3379,3396,3414,3432,3450,3468,3486,3504,3522,3541,3559,3578,3596,
	3615,3634,3653,3672,3691,3710,3730,3749,3769,3789,3808,3828,3848,3868,3888,3909,3929,3950,3970,3991,4012,4033,4054,4075,4095
};


int main(void)
{
	// Use direct internal Oscillator (8MHz) for clocks
	//Clockprescaler = 2:
	CLKPR = 1 << CLKPCE;
	CLKPR = (0 << CLKPCE) | (1 << CLKPS0);
		
	// Register Setup für Timer:
	// Compare Match (FastPWM) at OC1A/OC1B
	//																	FastPWM Mode (Register ICR1 compare)
	//																								Clock select (clk/1)
	TCCR1A = (1 << COM1A1)|(0 << COM1A0)|(1 << COM1B1)|(0<<COM1B0)	|	(1<<WGM11)|(0<<WGM10);	
	TCCR1B =															(1<<WGM13)|(1<<WGM12)	|	(0<<CS12)|(0<<CS11)|(1<<CS10);
	
	
	// Compare Register for reset (12Bit) 0000 1111 1111 1111
	ICR1H = 0xF;//(1<<ICR1H0) | (1<<ICR1H1) | (1<<ICR1H2) | (1<<ICR1H3);
	ICR1L = 0xFF;
	
	// 8MHz / 2^12 = 2kHz -> Target frequency 1KHz for Meanwell LDD-H
	
	//PWM Pins as output
	DDRA  = (1<<DDA5) | (1<<DDA6);
	PORTA = 0;	
	_NOP();
	
	
	
	// Register für ADC:
	
	// Turn  on ADC unit
	PRR |= 0<<PRADC;
	
	ADCSRA |= 1<<ADPS2 | 1<<ADPS1 | 1<<ADPS0;	//ADC Prescaler von 128
	
	
	// Init brightness
	// When timer >OCR1 than switch off
	OCR1AH = 0<<OCR1AH0 | 0<<OCR1AH1 | 0<<OCR1AH2 | 0<<OCR1AH3;
	OCR1AL = 0x3F;
	
	OCR1BH = 0<<OCR1BH0 | 0<<OCR1BH1 | 0<<OCR1BH2 | 0<<OCR1BH3;
	OCR1BL = 0x00;
	
	
	
	uint16_t ad1 = 0;
	uint16_t ad2 = 0;
	uint16_t pwm = 0x3F;
	
    while(1)
    {
		_NOP();
				
		ADCSRA |= 1<<ADEN;	// Turn on ADC
		ADCSRA |= 1<<ADSC;	// Start ADC conversion
		
		while (ADCSRA & (1<<ADSC) ) { }       // wait for conversion finish
		// ADCW one time read otherwise next conversion doesnt work
		volatile uint8_t tmp = (uint8_t) ADCW;

		
		//First Capture
		ADMUX = 1<<MUX0;	// Select channel 
		ADCSRA |= 1<<ADSC;	// Conversion
		_delay_ms(5);		
		ad1 = ADCW;			// Copy
		
		//Second Capture
		ADMUX = 1<<MUX1;
		ADCSRA |= 1<<ADSC;
		_delay_ms(5);
		ad2 = ADCW;
		
		//Turn of ADC
		ADCSRA |= 0<<ADEN;
		
		_NOP();		
		 		
		OCR1A = pgm_read_word(& pwmtable_16[ad1 & 0x3FF]);	
		OCR1B = pgm_read_word(& pwmtable_16[ad2 & 0x3FF]);	
      
		_delay_ms(50);	// Not the best way (busy waiting) -> Better powersaving		
    }
	
	return 0;
}